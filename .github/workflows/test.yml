name: Test Suite

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
      
      - name: Run unit and component tests with coverage
        run: |
          pytest tests/ \
            -m 'not integration and not e2e' \
            --cov=src/yui \
            --cov-report=xml \
            --cov-report=term-missing \
            --tb=short \
            --ignore=tests/test_meeting_manager.py \
            --ignore=tests/test_meeting_minutes.py \
            --ignore=tests/test_meeting_recorder.py \
            --ignore=tests/test_meeting_transcriber.py
      
      - name: Check coverage threshold
        run: |
          coverage report --fail-under=80 \
            --omit="src/yui/meeting/manager.py,src/yui/meeting/minutes.py,src/yui/meeting/recorder.py,src/yui/meeting/transcriber.py"
      
      - name: Check mock coverage
        run: |
          python3 scripts/check_mock_coverage.py
      
      - name: Check unused mocks
        run: |
          python3 scripts/check_unused_mocks.py
      
      - name: Check fixture duplication
        run: |
          python3 -c "
          import sys
          from pathlib import Path
          from collections import Counter
          import ast
          
          fixtures = []
          for f in Path('tests').glob('**/conftest.py'):
              tree = ast.parse(f.read_text())
              for node in ast.walk(tree):
                  if isinstance(node, ast.FunctionDef):
                      for dec in node.decorator_list:
                          if (isinstance(dec, ast.Name) and dec.id == 'fixture') or \
                             (isinstance(dec, ast.Attribute) and dec.attr == 'fixture') or \
                             (isinstance(dec, ast.Call) and hasattr(dec.func, 'id') and dec.func.id == 'fixture') or \
                             (isinstance(dec, ast.Call) and hasattr(dec.func, 'attr') and dec.func.attr == 'fixture'):
                              fixtures.append((node.name, str(f)))
                              break
          
          counts = Counter([name for name, _ in fixtures])
          duplicates = {name: count for name, count in counts.items() if count > 1}
          
          if duplicates:
              print('❌ Duplicate fixtures found:')
              for name, count in duplicates.items():
                  print(f'  {name}: {count} definitions')
                  for fname, fpath in fixtures:
                      if fname == name:
                          print(f'    - {fpath}')
              sys.exit(1)
          else:
              print('✅ No duplicate fixtures')
          "
      
      - name: Upload coverage artifact
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  integration:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        python-version: ["3.13"]
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      YUI_TEST_AWS: "1"
      YUI_AWS_E2E: "1"
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_BOT_TOKEN_AYA: ${{ secrets.SLACK_BOT_TOKEN_AYA }}
      YUI_TEST_SLACK: "1"
      YUI_TEST_SLACK_CHANNEL: ${{ secrets.YUI_TEST_SLACK_CHANNEL }}
      YUI_LIVE_INTEGRATION: "1"

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
      
      - name: Run integration tests
        run: |
          pytest tests/ \
            -m 'integration' \
            --tb=short \
            -v \
            --ignore=tests/test_meeting_manager.py \
            --ignore=tests/test_meeting_minutes.py \
            --ignore=tests/test_meeting_recorder.py \
            --ignore=tests/test_meeting_transcriber.py

  e2e:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        python-version: ["3.13"]
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      YUI_TEST_AWS: "1"
      YUI_AWS_E2E: "1"
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_BOT_TOKEN_AYA: ${{ secrets.SLACK_BOT_TOKEN_AYA }}
      YUI_TEST_SLACK: "1"
      YUI_TEST_SLACK_CHANNEL: ${{ secrets.YUI_TEST_SLACK_CHANNEL }}
      YUI_LIVE_INTEGRATION: "1"

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
          playwright install chromium --with-deps
      
      - name: Run E2E tests
        run: |
          pytest tests/ \
            -m 'e2e' \
            --tb=short \
            -v \
            --ignore=tests/test_meeting_manager.py \
            --ignore=tests/test_meeting_minutes.py \
            --ignore=tests/test_meeting_recorder.py \
            --ignore=tests/test_meeting_transcriber.py
