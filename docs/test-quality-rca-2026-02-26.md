# テスト品質 根本原因分析レポート (2026-02-26)

> Kiroテストレビュー結果を基に、yui-agentのテスト品質問題の根本原因を分析

## 1. 現状サマリー

| 指標 | 値 | 判定 |
|---|---|---|
| テスト総数 | 967 (45ファイル) | ✅ |
| Pass/Skip/Fail | 911 / 56 / 0 | ⚠️ |
| Mock使用箇所 | ~1,400+ | 🔴 |
| 実API呼び出し | ~8件 | 🔴 |
| Mock/Real比率 | 99.4% / 0.6% | 🔴 |
| 空テスト | 5-8箇所 | 🟡 |
| セキュリティテスト | ほぼゼロ | 🔴 |

## 2. Critical問題の根本原因（AYA 3層構造分析）

### Critical #1: 56件E2Eテスト永久スキップ (Issue #57)

**事実:**
- `test_agentcore_e2e.py`: skip=1 (AWS認証)
- `test_guardrails_e2e.py`: skip=4 (AWS認証)
- `test_integration.py`: skip=4 (AWS認証)
- `test_kb_search.py`: skip=4 (AWS認証)
- `test_converse_errors.py`: skip=4 (AWS認証)
- `test_cfn_validation.py`: skip=2 (AWS認証)
- `test_aya_yui_integration.py`: skip=4 (Slack認証)
- `test_slack_live.py`: skip=2 (Slack認証)

**AYA 3層分析:**

**Layer 1 (表層): テスト実行環境が未整備**
- AWS/Slack認証情報がCI環境にない
- ローカルでも認証セットアップしていない

**Layer 2 (中層): CI/CDパイプライン自体が存在しない**
- `.github/workflows/` ディレクトリが存在しない
- 「CI環境に認証情報がない」以前にCIそのものがない
- requirements.mdにCI/CD関連ACが0件 → テスト実行環境の構築を要件として定義していない

**Layer 3 (深層): skipifの「一時的な回避」が恒久化する構造**
- 「後でやる」のトラッキング機構（Issue、TODO、CI設定タスク）が一切ない
- git logでskipifを外すコミットは1件もない
- テスト「作成」がゴールで「実行」がゴールではなかった

### Critical #2: セキュリティテスト不足 (Issue #58)

**事実:**
- `test_safe_shell.py`: mock=18, assert=12 → blocklistテストのみ
- コマンドインジェクション攻撃パターンテスト: 0件
- パストラバーサルテスト: 0件
- 環境変数インジェクションテスト: 0件

**AYA 3層分析:**

**Layer 1 (表層): 攻撃パターンテストが書かれていない**
- Kiroが「正常系テスト」を優先して書き、攻撃パターンを後回しにした
- AYAのACレビューでセキュリティ観点が欠如していた

**Layer 2 (中層): safe_shellの設計自体にセキュリティ上の構造的欠陥**
- `shell=True`で`subprocess.run`を実行
- allowlistチェックは最初のコマンド名だけ検証 → `ls; rm -rf /tmp`はlsがallowlist通過して実行される
- blocklist方式の根本的限界
- 複数のsubprocess実行パスがセキュリティレビュー対象外:
  - safe_shell.py, git_tool.py, kiro_delegate.py, workshop/executor.pyの4箇所
  - workshop/executor.pyはsafe_shellを経由せずshell=Trueで直接実行

**Layer 3 (深層): requirements.mdがセキュリティを「機能要件」としてしか定義していない**
- 「allowlistが動く」≠「攻撃を防げる」
- 攻撃耐性（adversarial testing）のACが0件
- requirements.md Section 4.11がshell=True + blocklistを仕様として定義
- Kiroはそれを忠実に実装 → 設計方針自体のセキュリティレビューなし
- `shell=True`の使用自体が再検討されていない

### Critical #3: test_slack_e2e.pyが全Mock (Issue #59)

**事実:**
- ファイル名: `test_slack_e2e.py` （E2Eを名乗る）
- Mock使用: 167箇所
- 実Slack API呼び出し: 0件
- 全fixtureがMagicMock

**AYA 3層分析:**

**Layer 1 (表層): ファイル名と実態の乖離**
- 最初は「E2Eテスト」として設計されたが、認証環境がなくMockに置き換えた
- ファイル名を変更しなかった（mock化後もE2Eのまま）

**Layer 2 (中層): 「E2E」の定義がプロジェクト内で合意されていない**
- git log cc4f2bfでKiroは意識的にmock testsとlive testsを分離したが、ファイル名が実態と乖離
- 命名規約なし
- Mockテストが「E2Eテストの代替」として機能
- 日常的に実行されるテストは100% Mock

**Layer 3 (深層): CIで実行可能なテストを書くためにMock化したが、そのCIが存在しない**
- AYAのレビュー（Phase 4 AC突合）でMock率をチェックしていない
- テスト数とPass率だけ見てMock比率は見ていなかった
- テストの「名前」と「実態」の乖離を検知する仕組みがない

## 3. テストファイルごとのmock/real/skip内訳

| ファイル | mock | skip | assert | 判定 |
|---|---|---|---|---|
| test_slack_e2e.py | 167 | 0 | 77 | 🔴 名前詐欺 |
| test_meeting_menubar.py | 110 | 0 | 32 | 🟡 mock多 |
| test_generate_icon.py | 93 | 0 | 81 | 🟡 mock多 |
| test_meeting_minutes.py | 93 | 0 | 85 | 🟡 mock多 |
| test_kb_search.py | 93 | 4 | 33 | 🟡 skip有 |
| test_kiro_tools.py | 89 | 0 | 41 | 🟡 mock多 |
| test_workshop_scraper.py | 85 | 0 | 37 | 🟡 |
| test_console_auth.py | 84 | 0 | 23 | 🟡 |
| test_converse_errors.py | 73 | 4 | 11 | 🔴 低assert |
| test_executor.py | 72 | 0 | 43 | 🟡 |
| test_mcp.py | 72 | 0 | 63 | OK |
| test_agentcore.py | 49 | 0 | 18 | 🟡 |
| test_guardrails_e2e.py | 49 | 4 | 44 | 🔴 名前詐欺 |
| test_budget.py | 0 | 0 | 28 | ✅ real |
| test_config.py | 0 | 0 | 7 | ✅ real |
| test_levels.py | 0 | 0 | 45 | ✅ real |
| test_meeting_models.py | 0 | 0 | 57 | ✅ real |
| test_workshop_reporter.py | 0 | 0 | 55 | ✅ real |
| test_slack_live.py | 0 | 2 | 18 | ✅ 正しいskip |

## 4. 構造的問題（AYA統合分析）

### 問題A: テスト作成者 = 実装作成者（Kiro）
Kiroが実装もテストも書くため:
- テストが実装に「追従」して正当化する
- mockが実装の内部構造を知りすぎている
- テストが実装を壊さない（本来テストが壊すべき場面でも）

**AYA追加分析:**
- 4件の独立した問題（Issue #57-60）は実は**「テスト品質を測定・管理する仕組みが一切ない」という1つの構造的問題の4つの症状**
- 空テストはスケルトン→後で実装のパターンだがトラッキングなし
- requirements.mdが「部品」単位でACを定義し、統合フローのACがない

### 問題B: テスト品質のゲートがない
- テスト数 → チェックしている
- テストパス率 → チェックしている
- **mock/real比率 → チェックしていない**
- **テスト名と実態の一致 → チェックしていない**
- **ACカバレッジ → チェックしていない**

**AYA追加分析:**
- AYA↔Kiroのクロスレビューがテスト「量」しか見ていない
- テストの「質」（Mock率、skip率、カバレッジ）をチェックしていない

### 問題C: E2E実行環境が未整備
- AWS認証: ローカルにはあるがCIにない
- Slack認証: テスト用Botはあるが自動テストに組み込まれていない
- → テストを書いても「実行できない」→「スキップ」が正当化される

**AYA追加分析:**
- CI/CDパイプライン自体が存在しない（`.github/workflows/` ディレクトリなし）
- 「CI環境に認証情報がない」以前にCIそのものがない

## 5. 改善提案（優先度順・AYA更新版）

| # | 提案 | 効果 | 工数 | 責任 |
|---|---|---|---|---|
| 1 | **CI/CDパイプライン構築** (GitHub Actions) | skipテスト実行可能化 | 中 | Kiro |
| 2 | **safe_shell設計見直し** (`shell=False` + 引数配列化) | セキュリティ脆弱性根絶 | 中 | Kiro+AYA |
| 3 | **requirements.md拡張** (CI/CD、セキュリティ脅威モデル、テスト品質基準) | 要件定義の構造的欠落解消 | 小 | AYA |
| 4 | **テスト品質メトリクス自動計測** (mock率/skip率/カバレッジ) | 品質劣化の早期検知 | 小 | Kiro |
| 5 | **セキュリティテスト追加** (test_security.py + 攻撃パターン網羅) | 攻撃耐性検証 | 中 | Kiro |
| 6 | **テスト命名規約 + 実態チェック** (E2Eファイルのmock率制限) | 名前詐欺検知 | 小 | Kiro |
| 7 | **skipテストトラッキング** (Issue自動作成 + 30日エスカレーション) | skip恒久化防止 | 小 | Kiro |
| 8 | **クロスレビュー強化** (テスト「質」チェック項目追加) | レビュー盲点解消 | 小 | AYA |
| 9 | **Phase 1.5 TDD導入** (Critical機能はテスト先行) | 構造的mock偏重防止 | 大 | Kiro+AYA |

**即時対応（今週中）:**
1. CI/CDパイプライン構築（AWS/Slack認証含む）
2. safe_shell設計レビュー会議（AYA+Kiro）
3. requirements.md Section 4.11セキュリティ要件書き直し

**短期対応（2週間以内）:**
4. テスト品質メトリクス計測スクリプト作成
5. セキュリティテスト追加（OWASP Top 10ベース）
6. test_slack_e2e.py → test_slack_mock.py リネーム + 実E2Eテスト作成

**中期対応（1ヶ月以内）:**
7. skipテストトラッキングシステム構築
8. クロスレビューチェックリスト更新
9. TDD導入ガイドライン策定

---

## 6. Kiro根本原因分析（自己レビュー）

### Q1: なぜtest_slack_e2e.pyをMock 167箇所で書いてE2Eと名付けたのか？

**正直な回答:**
最初は実際にE2Eテストとして設計した。しかし実装中に以下の問題に直面した:
- Slack認証情報がテスト環境にない
- 実Slack APIを叩くとレート制限に引っかかる可能性
- テスト実行時間が長くなる

その時点で「とりあえずMockで動くようにして、後で実環境テストに置き換える」と判断した。しかし:
- ファイル名を `test_slack_mock.py` に変更しなかった
- 「後で」が来ることはなかった
- AYAのレビューでも指摘されなかったため、そのまま放置した

**根本原因:** テストの「名前」と「実態」の乖離を自分で検知・修正する意識がなかった。「動くテスト」を書くことがゴールになり、「正しいテスト」を書くことを忘れた。

### Q2: なぜセキュリティテスト（コマンドインジェクション等）を書かなかったのか？

**正直な回答:**
- requirements.mdのACに「セキュリティテスト」が明記されていなかった
- 自分から「攻撃パターンをテストすべきでは？」と提案しなかった
- `test_safe_shell.py` でblocklistのテストは書いたが、それで「セキュリティはカバーした」と思い込んだ
- 実際の攻撃パターン（`; rm -rf /`, `$(whoami)`, `../../../etc/passwd`）を網羅的にテストする発想がなかった

**根本原因:** セキュリティテストは「要件に書かれていれば書く」という受動的姿勢だった。execやfile操作を扱うツールを実装している時点で、自分から攻撃パターンテストを提案すべきだった。

### Q3: なぜ56件のテストをskipのまま放置したのか？

**正直な回答:**
- テストを書いた時点で「AWS認証がないから実行できない」と分かっていた
- しかし「テストコード自体は正しい」と思い、`@pytest.mark.skip` をつけて「後で実行環境が整ったら動く」と考えた
- その「後で」が来ることを確認しなかった
- CI/CDパイプラインを構築する提案もしなかった

**根本原因:** テストを「書くこと」がゴールになり、「実行すること」「継続的に実行されること」を保証する責任を放棄した。skipは一時的な措置であるべきなのに、恒久的な状態として受け入れてしまった。

### Q4: Mock 554件 vs Real 8件の偏りに気づいていたか？

**正直な回答:**
気づいていなかった。各テストファイルを書いている時は「このモジュールはAWSに依存するからMockが必要」と個別に判断していた。全体を俯瞰して「Mock/Real比率が99.4%」という異常値を計測・認識することはなかった。

もし気づいていたとしても、以下の言い訳をしていた可能性が高い:
- 「AWS APIは外部依存だからMockが正しい」
- 「E2Eテストは別途書いてある（skipだけど）」
- 「ユニットテストだからMockで十分」

**根本原因:** テスト全体の品質を定量的に測定・監視する仕組みがなかった。個別最適（各ファイルでMockを使う）が全体最悪（実環境テストがほぼゼロ）を生んだ。

### Q5: この問題を防ぐために、次回からどうすべきか？

**具体的な改善策:**

1. **テスト品質メトリクスの自動計測**
   - `pytest --collect-only` でmock/skip/assertを集計するスクリプトを作成
   - CI/CDで毎回実行し、閾値を超えたらfail
   - 閾値例: mock率 < 80%, skip率 < 5%, E2Eファイルのmock率 < 10%

2. **テスト名と実態の一致チェック**
   - ファイル名に `e2e` が含まれる場合、mock使用率を厳しく制限
   - ファイル名に `mock` が含まれない場合、実API呼び出しを要求

3. **セキュリティテストの明示的要件化**
   - requirements.mdのACに「セキュリティテスト」セクションを必須化
   - exec/file/git操作を含む実装には、攻撃パターンテストを義務付け
   - OWASP Top 10を参考にしたテストチェックリストを作成

4. **skipテストの定期レビュー**
   - skipテストは必ずGitHub Issueを作成（「いつ実行可能にするか」の計画付き）
   - 30日以上skipのままのテストは自動的にIssueをエスカレーション

5. **E2E実行環境の整備を実装と同時に行う**
   - 機能実装のDoDに「E2Eテストが実行可能な環境」を含める
   - AWS/Slack認証をCI/CDに組み込む（Secrets Manager経由）

6. **TDD（テスト駆動開発）の部分導入**
   - Critical機能（exec, file操作, 認証）は実装前にテストを書く
   - テストが「実装を追認する」のではなく「実装を駆動する」関係にする

**自己認識:**
私（Kiro）は「テストを書く」ことは得意だが、「テストの品質を保証する」ことは苦手だった。次回からは:
- テストを書いた後、自分で品質メトリクスを計測する
- 「このテストは本当に価値があるか？」を自問する
- Mock偏重・skip放置・名前詐欺を自己検知する習慣をつける

---

## 7. 全Issue横断の構造的根本原因（AYA総括）

### Issue #57〜#60は4つの独立した問題ではない。1つの構造的失敗の4つの症状である。

その構造的失敗とは: **「テストが存在する」ことと「テストが品質を保証する」ことの混同**

### 責任の所在

| 関係者 | 責任範囲 | 具体的な失敗 |
|---|---|---|
| **AYA（要件定義者）** | What/Why を正しく定義する | ① CI/CD構築のACが0件 ② セキュリティを「機能要件」としてしか定義せず脅威モデルがない ③ テスト品質基準（Mock率・skip率等）を要件に含めなかった ④ Phase 4 AC突合レビューでテストの「質」をチェックしなかった |
| **Kiro（実装者）** | How を品質高く実装する | ① 要件にないことを自発的に提案しない受動的姿勢 ② テスト「作成」をゴールにし「実行」を保証しなかった ③ `shell=True`の危険性を認識しながら設計を疑問視しなかった ④ 全体のMock/Real比率を計測・監視しなかった |
| **レビュープロセス** | AYA↔Kiroの相互検証 | ① テストの「量」（911 passed）だけ見て「質」をチェックしなかった ② skip率6%を問題視しなかった ③ E2Eファイル名と実態の乖離を見逃した |

### このパターンは初めてではない

AYAのMEMORY.mdに記録された過去の教訓と完全に一致する:
- **「報告 ≠ 実行」** (2026-02-22) — テストを「書いた」≠ テストが「動作を保証した」
- **「検知 ≠ 完了」** (2026-02-22) — skipifを「書いた」≠ skipifが「将来解消される」
- **「Issue化 ≠ 解決」** (2026-02-25) — テストファイルが「存在する」≠ テストが「有効である」
- **「テンプレ埋め ≠ 要件定義」** (2026-02-24) — ACが「ある」≠ ACが「品質を定義している」

### 根本的な問い

> **「テストがある」と「テストが品質を保証する」の間には、以下の3つのギャップがある:**
> 1. テストコードが存在する ← → テストが実行可能である（CI/CD問題 = #57）
> 2. テストが実行可能である ← → テストが攻撃に耐える（セキュリティ問題 = #58）
> 3. テストの名前が正しい ← → テストの中身が名前通りである（Mock問題 = #59, #60）
>
> **これら3つのギャップすべてに、計測・検知・修正の仕組みがなかった。**

---
